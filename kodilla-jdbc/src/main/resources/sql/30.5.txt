DROP TABLE STATS;
DROP VIEW BESTSELLERS_COUNT;

DELIMITER $$

CREATE TABLE STATS (
STAT_ID INT (11) AUTO_INCREMENT PRIMARY KEY,
STAT_DATE DATETIME NOT NULL,
STAT VARCHAR (20) NOT NULL,
VALUE INT (11) NOT NULL
);

CREATE VIEW BESTSELLERS_COUNT AS
	SELECT COUNT(*) FROM BOOKS 
    WHERE BESTSELLER = "true";
    
USE KODILLA_COURSE;

CREATE EVENT UPDATE_STATS
	ON SCHEDULE EVERY 1 minute
    DO 
	BEGIN
		INSERT INTO STATS(STAT_DATE, STAT, VALUE)
			VALUES(CURDATE(), "BESTSELLERS", (SELECT * FROM BESTSELLERS_COUNT));
            
	CALL UpdateBestsellers();
    
	END $$
    
DELIMITER ;

 DROP EVENT UPDATE_STATS;