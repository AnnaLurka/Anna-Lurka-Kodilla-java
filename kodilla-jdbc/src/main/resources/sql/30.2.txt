DROP PROCEDURE IF EXISTS UpdateBestsellers;
DELIMITER $$
CREATE PROCEDURE UpdateBestsellers()
BEGIN
	DECLARE BOOKSRENTED, BK_ID, DAYS, RDR_ID INT;
	DECLARE BOOKRENTEDPERMONTH DECIMAL (5,2);
	DECLARE FINISHED INT DEFAULT 0;
	DECLARE ALL_BOOKS CURSOR FOR SELECT BOOK_ID FROM BOOKS;
	DECLARE CONTINUE HANDLER FOR NOT FOUND SET FINISHED = 1;
	OPEN ALL_BOOKS;
	WHILE(FINISHED = 0) DO
		FETCH ALL_BOOKS INTO BK_ID;
			IF(FINISHED = 0) THEN
				SELECT COUNT(*) FROM RENTS
				WHERE BOOK_ID = BK_ID
				INTO BOOKSRENTED;
				SELECT DATEDIFF(MAX(RENT_DATE), MIN(RENT_DATE)) FROM RENTS
				WHERE BOOK_ID = BK_ID
				INTO DAYS;
				SET BOOKRENTEDPERMONTH = BOOKSRENTED / DAYS * 30;
				IF(BOOKRENTEDPERMONTH > 2) THEN
					UPDATE BOOKS SET BESTSELLER = "true"
                    WHERE BOOK_ID = BK_ID;
				ELSE
					UPDATE BOOKS SET BESTSELLER = "false"
                    WHERE BOOK_ID = BK_ID;
				END IF;    
            COMMIT;
            END IF;
	END WHILE;
    CLOSE ALL_BOOKS;
END $$
DELIMITER ;
